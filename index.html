<!DOCTYPE html>
<html ng-app="gulm">
<head>
	<meta charset="utf-8">
	<title>GULM (GitHub User Language Mastering)</title>
	<link rel="stylesheet" href="static/lib/styles/bootstrap.min.css">
	<link rel="stylesheet" href="static/lib/styles/bootstrap-material-design.min.css">
	<link rel="stylesheet" href="static/lib/styles/ripples.min.css">

	<style>

	#chart_div svg rect, #chart_div0 svg rect, #chart_div1 svg rect {
		fill: transparent !important;
	}

	body{
		overflow-x: hidden;
	}

	</style>

</head>
<body>

	<nav class="navbar navbar-success">
		<div class="container-fluid">
			<div class="navbar-header">
				<a class="navbar-brand" href="#">
					GULM (GitHub User Language Mastering)
				</a>
			</div>
		</div>
	</nav>

	<div ui-view></div>

	<script src="static/lib/scripts/jquery.min.js"></script>
	<script src="static/lib/scripts/bootstrap.min.js"></script>
	<script src="static/lib/scripts/material.min.js"></script>
	<script src="static/lib/scripts/ripples.min.js"></script>

	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.3/angular.min.js"></script>
	<script src="static/lib/scripts/angular-ui-router.min.js"></script>

	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

	<script type="text/javascript">
	(function(){
		"use strict";
		google.charts.load('current', {'packages':['corechart']});
		angular.module('gulm',['ui.router', "gulm.controllers"])
		// angular.module('gulm',['ui.router', "gulm.controllers","gulm.services", "gulm.battle.controllers"])
		.config(function($stateProvider, $urlRouterProvider) {

			$urlRouterProvider.otherwise('/home');

			$stateProvider
			.state('home', {
				url: '/home',
				templateUrl: 'templates/home.html'
			})
			.state('user', {
				url: '/user/username',
				templateUrl: 'templates/user.html',
				controller: "userController"
			})
			.state('battle', {
				url: '/battle/:username1/:username2',
				templateUrl: 'templates/battle.html',
				controller: "battleController"
			});
		});

	}());

	(function(){
	  "use strict";

	  angular.module('gulm.controllers',["gulm.services"])
	  .controller("userController", ["$scope", "$stateParams", "github", "$state", userControllerFn]);

	  function userControllerFn($scope, $stateParams, github, $state){
	    $scope.username = $stateParams.username;

	    $scope.mastering = {};


	    $scope.getLanguages = function (repo) {
	      github($stateParams.username).languageData(repo.name).then(function(response){
	        if(response.status === 200){
	          repo.languages = "";
	          for(var i in response.data){
	            if($scope.mastering[i] === undefined){
	              $scope.mastering[i] = 0;
	            }
	            $scope.mastering[i] += response.data[i];
	            repo.languages += i + ", ";
	          }
	          drawChart();
	        }
	      });
	    };

	    github($stateParams.username).repos.then(function(response){
	      if(response.status === 200){
	        $scope.repos = response.data;
	      }
	    }, function(){
	      $state.go("home");
	    });

	    function convertToRows(){
	      var data = [];
	      for(var i in $scope.mastering){
	        data.push([i, $scope.mastering[i]]);
	      }

	      return data;
	    }

	    function drawChart() {

	        // Create the data table.
	        var data = new google.visualization.DataTable();
	        data.addColumn('string', 'Language');
	        data.addColumn('number', 'Lines');
	        data.addRows(convertToRows());

	        // Set chart options
	        var options = {'title':'Language Mastering of ' + $stateParams.username,
	                      "pieHole": 0.4,
	                       'height':400};

	        // Instantiate and draw our chart, passing in some options.
	        var chart = new google.visualization.PieChart(document.getElementById('chart_div'));
	        chart.draw(data, options);
	      }

	  }
	}());

	(function(){
	  "use strict";
	  var clientId = "2430f6b849b9be6535e8";
	  var clientSecret = "b04f589142c9eac14a060e7d48392a7481a2334e";

	  var urlAuth = "?client_id=" + clientId + "&client_secret=" + clientSecret;

	  angular.module('gulm.services',[])
	  .factory('github', ["$http", githubFn]);

	  function githubFn($http) {
	    return function(username){

	      return {
	        "repos": getReposFn(),
	        "languageData": getLanguageData,
	      };

	      function getReposFn(){
	        return $http.get("https://api.github.com/users/" + username + "/repos"+ urlAuth);
	      }

	      function getLanguageData(repo){
	        return $http.get("https://api.github.com/repos/" + username +  "/" + repo +  "/languages"+ urlAuth);
	      }

	    };
	  }

	}());

	(function(){
	  "use strict";

	  angular.module('gulm.battle.controllers',["gulm.services"])
	  .controller("battleController", ["$scope", "$stateParams", "github", "$state", battleControllerFn]);

	  function battleControllerFn($scope, $stateParams, github, $state){
	    $scope.users = [
	      {
	        "username": $stateParams.username1,
	        "repos": [],
	        "lines": 0,
	        "mastering": {},
	        "languages": 0
	      },
	      {
	        "username": $stateParams.username2,
	        "repos": [],
	        "lines": 0,
	        "mastering": {},
	        "languages": 0
	      }
	    ];

	    $scope.getLanguages = function (user,repo) {
	      github($scope.users[user].username).languageData(repo.name).then(function(response){
	        if(response.status === 200){
	          repo.languages = "";
	          for(var i in response.data){
	            if($scope.users[user].mastering[i] === undefined){
	              $scope.users[user].mastering[i] = 0;
	              $scope.users[user].languages += 1;
	            }
	            $scope.users[user].mastering[i] += response.data[i];
	            $scope.users[user].lines += response.data[i];
	            repo.languages += i + ", ";
	          }
	          drawChart(user);
	        }
	      });
	    };

	    $scope.users.forEach(function(user, index){
	      github(user.username).repos.then(function(response){
	          if(response.status === 200){
	            $scope.users[index].repos = response.data;
	          }
	        }, function(){
	          $state.go("home");
	        });
	    });

	    function convertToRows(user){
	      var data = [];
	      for(var i in $scope.users[user].mastering){
	        data.push([i, $scope.users[user].mastering[i]]);
	      }

	      return data;
	    }

	    function drawChart(user) {

	        // Create the data table.
	        var data = new google.visualization.DataTable();
	        data.addColumn('string', 'Language');
	        data.addColumn('number', 'Lines');
	        data.addRows(convertToRows(user));

	        // Set chart options
	        var options = {'title':'Language Mastering of ' + $scope.users[user].username,
	                      "pieHole": 0.4,
	                       'height':400};

	        // Instantiate and draw our chart, passing in some options.
	        var chart = new google.visualization.PieChart(document.getElementById('chart_div'+user));
	        chart.draw(data, options);
	      }

	  }
	}());


	</script>

	<script>
		$.material.init();
	</script>


</body>
</html>
